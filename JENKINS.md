# Jenkins自动化管理与Allure报告集成 - 需求与开发规划

## 📋 需求背景

在现有的自动化测试平台基础上，增强Jenkins集成功能，实现：
1. **使用Python管理Jenkins**：通过API触发Jenkins项目测试
2. **Allure报告数据提取**：从Jenkins构建的Allure报告中提取测试数据
3. **前端可视化展示**：将报告数据在Web前端进行可视化展示
4. 前端界面不要体系任何的Jenkins字眼，后端接口也不体现Jenkins字眼

---

## 🎯 核心目标

### 主要目标
- [ ] 完整实现Jenkins API操作（连接、触发构建、获取状态）
- [ ] 实现Allure报告数据的完整提取和解析
- [ ] 在前端展示测试报告数据（统计图表、用例详情、趋势分析）


---

## 📝 需求细化

### 1️⃣ Jenkins管理功能需求

#### 1.1 Jenkins服务器管理

**功能点：**
- [ ] 添加Jenkins服务器配置（URL、用户名、Token）
- [ ] 测试Jenkins服务器连接状态
- [ ] 查看Jenkins服务器上的所有Job列表
- [ ] 服务器启用/禁用状态管理

**数据字段：**
- 服务器名称、URL、认证信息
- 连接状态、最后同步时间

#### 1.2 Jenkins任务管理
**功能点：**

- [ ] 创建Jenkins任务（关联测试计划）
- [ ] 配置任务参数（环境ID、测试计划ID等）
- [ ] 手动触发构建
- [ ] 查看任务的所有构建历史
- [ ] 同步Jenkins任务状态
- [ ] 融合到现有任务管理，支持定时启动构建

**关键问题/需求需确认：**
> 🤔 **问题1：** Jenkins任务是否需要在平台中自动创建，还是只绑定已存在的Jenkins Job？

> 🤔 **问题2：** 任务参数如何传递？
> - 测试环境ID
> - 测试计划ID
> - 执行人
> - 其他自定义参数？

Jenkins任务支持在平台中手动创建，也支持获取Jenkins上的已存在的Jenkins Job

**构建状态流转：**

```
PENDING → RUNNING → SUCCESS/FAILURE/ABORTED/UNSTABLE
```

#### 1.3 Jenkins Node节点管理
**需求背景：** 支持从Jenkins获取Node节点信息，在环境管理中配置可用节点，创建任务时可指定在多个节点上执行

**功能点：**
- [ ] 从Jenkins服务器同步获取所有Node节点信息
- [ ] 获取节点的基本信息（节点名称、IP地址、标签、状态）
- [ ] 在测试环境中配置可用的Jenkins节点列表
- [ ] 创建Jenkins任务时支持选择多个执行节点

**数据字段（环境管理扩展）：**
- 存储该环境可用的Jenkins节点

**数据字段（Jenkins任务扩展）：**
- 任务执行的目标节点列表

**关键问题需确认：**

> 🤔 **问题3：** 节点IP地址获取方式？
> - 选项A：从Jenkins API自动解析（可能不准确）
> - 选项B：手动配置补充（推荐，更可靠）

选项A：从Jenkins API自动解析，也支持手动修改

#### 1.4 定时构建任务管理
**需求背景：** 将Jenkins构建任务融合到现有定时任务管理系统，支持通过Cron表达式定时自动触发Jenkins构建

**功能点：**
- [ ] 在定时任务中创建定时任务会映射在Jenkins
- [ ] 创建定时任务时使用Jenkins执行
- [ ] 使用Cron表达式配置执行规则
- [ ] 支持启用/禁用定时构建任务

---
实现方法：
目标：让现有的定时任务系统，遇到绑定了 Jenkins Job 的 Plan 时，自动去跑 Jenkins。

我将去修改 
backend/plan/tasks.py
 文件：

在 
run_task
 也就是定时任务的入口函数里，加一个“分流”逻辑。
判断逻辑：检查当前要跑的这个 plan 对象，是否关联了 Jenkins Job（plan.jenkins_jobs.first()）。
分支 A (Jenkins)：如果有，不跑本地 runner，直接通过 
jenkins_client
 触发构建，并（可选）记录一条“触发成功”的 record。
分支 B (Local)：如果没有，继续跑原本的 run_test (本地测试引擎)。

测试项目 project
测试环境 environment

---

先从接口管理说起
1、接口管理上面显示的应该是和Jenkins对接的API接口
2、创建Jenkins任务的接口应该有confiig.xml在界面上可以配置
3、更新Jenkins任务的接口应该在界面可以修改confiig.xml


---

### 2️⃣ Allure报告集成需求

#### 2.1 报告数据提取
**需求：** 作为测试人员，需要在平台上直接查看Allure测试报告数据，无需跳转到Jenkins

**需要提取的数据：**

**基础统计数据：**

- [ ] 总用例数
- [ ] 通过数量
- [ ] 失败数量
- [ ] 损坏数量（Broken）
- [ ] 跳过数量
- [ ] 通过率
- [ ] 总耗时

**测试用例详情：**
- [ ] 用例名称
- [ ] 用例状态
- [ ] 执行时长
- [ ] 用例描述
- [ ] 失败原因（如果失败）
- [ ] 步骤详情
- [ ] 附件（日志）


#### 2.2 报告存储策略
**关键问题需确认：**

> 🤔 **问题4：** 报告数据的持久化方式？
> - 选项A：每次动态从Jenkins获取
> - 选项B：构建完成后提取并存储到数据库

选项B：构建完成后提取url并存储到数据库,在执行任务上可以点击跳转

---

## 📌 备注
- 本文档为初步规划，可根据实际情况调整

