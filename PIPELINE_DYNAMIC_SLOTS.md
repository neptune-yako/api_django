# Pipeline 动态插槽实现方案

## 一、开发原因

### 1.1 业务需求
在实际的自动化测试场景中，Jenkins Job 的配置往往需要根据不同的执行环境、测试数据或业务参数进行动态调整。例如：
- 测试分数阈值 (`score`)
- 测试环境标识 (`env`)
- Git 分支名称 (`branch`)
- 测试用例标签 (`tags`)

传统的做法是为每种参数组合创建不同的 Job，这会导致 Job 数量激增，维护成本高昂。

### 1.2 技术目标
实现一套轻量级的"动态插槽"机制，允许用户在 XML 配置中使用 `{{variable}}` 语法定义参数占位符，在构建时通过 Web 界面动态填入具体值，从而实现"一个 Job 模板，多种参数组合"的灵活构建方式。

### 1.3 方案选择
本方案采用 **后端模板替换** 的实现方式，而非 Jenkins 原生的参数化构建（Parameterized Build），原因如下：
- **开发成本低**：无需深度修改前端可视化构建器 (`PipelineBuilder`)
- **灵活性高**：可在 XML 任意位置插入变量，不受 Jenkins 参数类型限制
- **适配场景**：适合通过自定义平台统一管理和触发构建的场景

---

## 二、实现步骤

### 2.1 用户使用流程
1. **创建/编辑 Job**：在 XML 编辑器中使用 `{{variable_name}}` 语法定义动态插槽
   ```xml
   <script>
     echo "Score threshold: {{score}}"
     pytest tests/ --env={{env}}
   </script>
   ```

2. **触发构建**：点击 Job 列表的"构建"按钮

3. **填写参数**：系统自动识别插槽，弹出参数输入表单

4. **执行构建**：后端替换变量后调用 Jenkins API 执行

### 2.2 后端实现流程
1. **新增接口**：`GET /api/jenkins/job/{id}/check_params`
   - 使用正则表达式扫描 `config_xml` 字段
   - 提取所有 `{{...}}` 中的变量名
   - 去重并返回参数列表

2. **修改构建接口**：`POST /api/jenkins/job/build`
   - 接收前端传入的参数键值对 `{"score": "95", "env": "prod"}`
   - 读取 Job 的 `config_xml`
   - 遍历参数进行字符串替换 `{{key}}` -> `value`
   - 使用替换后的 XML 更新 Jenkins Job
   - 触发构建

3. **安全处理**：
   - XML 特殊字符转义（`<`, `>`, `&` 等）
   - 参数值长度限制
   - 敏感信息脱敏（如密码类参数）

### 2.3 前端实现流程
1. **修改构建按钮逻辑**（`JobList.vue`）：
   - 点击构建时先调用 `check_params` 接口
   - 如果返回空数组，直接构建
   - 如果有参数，打开参数输入对话框

2. **新增参数输入组件**（`JobBuildDialog.vue`）：
   - 根据参数列表动态生成表单项
   - 每个参数默认使用 `<el-input>` 渲染
   - 提交时将表单数据作为 JSON 传给后端

3. **用户体验优化**：
   - 参数名作为 Label 显示
   - Placeholder 提示"请填写 {参数名}"
   - 支持记忆上次填写的值（LocalStorage）

---

## 三、主要问题

### 3.1 技术挑战
1. **正则匹配准确性**：如何避免误匹配（如注释中的 `{{...}}`）
2. **XML 格式破坏**：用户输入的值可能包含特殊字符
3. **并发安全**：多次构建时 XML 替换的原子性
4. **性能问题**：大型 XML 的正则扫描效率

### 3.2 用户体验问题
1. **参数提示不友好**：仅显示变量名，缺少描述信息
2. **类型验证缺失**：无法限制 `score` 必须是 0-100 的数字
3. **复杂输入支持**：长文本、代码块如何输入

---

## 四、问题 Q&A

### Q1: 如何知道用户定义了几个动态插槽？
**回答**：通过正则表达式扫描 XML 内容。

**是否能实现**：✅ 能实现

**实现方式**：
```python
import re
slots = set(re.findall(r'\{\{(.*?)\}\}', xml_content))
```
使用 `set()` 自动去重，确保同一个变量只需要填写一次。

---

### Q2: 如何在填写时显示提示"请填写 {{score}}"？
**回答**：前端根据参数名动态拼接提示语。

**是否能实现**：✅ 能实现

**实现方式**：
```javascript
const placeholder = `请填写 ${paramName}`
```
进阶方案可以支持用户在创建 Job 时为每个参数添加自定义描述。

---

### Q3: 如何实现多个参数的一一对应？
**回答**：使用 Map 数据结构存储键值对，后端遍历替换。

**是否能实现**：✅ 能实现

**实现方式**：
- 前端收集：`{"score": "95", "name": "ZhangSan"}`
- 后端替换：
  ```python
  for key, value in params.items():
      xml = xml.replace(f'{{{{{key}}}}}', str(value))
  ```

---

### Q4: 如果参数值是很长的代码怎么办？
**回答**：根据参数类型渲染不同的输入控件。

**是否能实现**：✅ 能实现（需要扩展）

**实现方式**：
1. **基础版**：所有参数统一使用 `<el-input type="textarea">`
2. **进阶版**：支持参数元数据定义
   ```json
   {
     "score": {"type": "number", "min": 0, "max": 100},
     "script": {"type": "code", "language": "python"}
   }
   ```
   前端根据 `type` 字段选择渲染组件：
   - `number` -> `<el-input-number>`
   - `code` -> `<VAceEditor>`

---

### Q5: 如何避免 XML 格式被用户输入破坏？
**回答**：后端进行 XML 转义处理。

**是否能实现**：✅ 能实现

**实现方式**：
```python
import xml.sax.saxutils as saxutils

def escape_xml_value(value):
    return saxutils.escape(str(value))

# 替换时使用
xml = xml.replace(f'{{{{{key}}}}}', escape_xml_value(value))
```

---

### Q6: 这种方案与 Jenkins 原生参数化的区别？
**回答**：本方案是"外部模板替换"，Jenkins 感知不到参数。

**是否能实现**：✅ 能实现，但有局限

**区别对比**：
| 特性 | 本方案 | Jenkins 原生 |
|------|--------|--------------|
| 开发成本 | 低 | 中 |
| 灵活性 | 高（任意位置插入） | 中（仅支持标准参数类型） |
| Jenkins 可见性 | 不可见 | 可见（Web UI 显示参数） |
| 历史记录 | 需自行记录 | Jenkins 自动记录 |
| 适用场景 | 自定义平台统一管理 | 直接使用 Jenkins UI |

---

## 五、后续优化方向

### 5.1 参数元数据支持
允许用户在创建 Job 时定义参数的详细信息：
- 参数类型（字符串、数字、布尔、选项）
- 默认值
- 验证规则（正则、范围）
- 描述文本

### 5.2 参数历史记录
记录每次构建使用的参数值，支持快速复用。

### 5.3 参数模板
预定义常用参数组合（如"生产环境"、"测试环境"），一键填充。

### 5.4 迁移到 Jenkins 原生
如果未来需要在 Jenkins Web UI 直接触发构建，可以将动态插槽转换为标准的 `<parameterDefinitions>` 配置。

---

## 六、总结

本方案通过 **后端正则扫描 + 字符串替换** 的轻量级实现，在不修改 `PipelineBuilder` 复杂逻辑的前提下，快速支持了 XML 动态插槽功能。虽然不是 Jenkins 的标准参数化方式，但在自定义平台场景下具有开发成本低、灵活性高的优势，能够满足大部分动态参数化构建的需求。
