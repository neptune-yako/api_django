import{_ as X}from"./none-CwC0Lq_I.js";import{_ as Y}from"./scene-3uiTL2pM.js";import{P as Z}from"./ProStore-981bTmq_.js";import{U as ee,h as _,E as o,a as te,b as ae}from"./index-Bqsb1G-Q.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as y,o as se,v as le,D as P,F as a,U as s,L as D,P as ie,M as n,u as c,O as oe,q as E,au as re,T as A,ao as u,E as g,R as m,a8 as de,S as C}from"./vue-CXALzJrr.js";const B="/assets/plan-DSiNIRfO.png",ue={class:"main_box"},pe={class:"card left_box"},ce={class:"title_box"},me={key:0},fe={key:1},_e={class:"card right_box"},ge={style:{background:"none"}},ve={class:"name_edit"},ye={class:"btns"},we={style:{background:"none","margin-top":"5px"}},xe={style:{display:"flex","align-items":"center"}},ke={class:"el-icon-s-help",style:{color:"#00aaff","font-weight":"bold"}},be={class:"select_content"},Pe={style:{"text-align":"center"}},Ce={__name:"Plan",setup(Le){const z=ee(),r=Z();let d=y({id:"",name:""}),v=y([]);function w(t){d.value=t,x(t.id)}se(()=>{r.planList.length>0&&w(r.planList[0])});async function N(){const t={project:r.proList.id,name:"测试计划",username:z.userInfo.username},e=await _.planApi.createPlan(t);e.status===201?(o({type:"success",title:"测试计划添加成功！",duration:1500}),await r.getPlanList(),w(e.data)):o({title:"测试计划添加失败！",type:"error",message:e.data.detail,duration:1500})}const L=y(!1);async function x(){L.value=!0;const t=await _.planApi.getPlanInfo(d.value.id);t.status===200&&(v.value=t.data.scene,L.value=!1)}async function T(){te.confirm("此操作不可恢复，确认要删除该计划?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning",center:!0}).then(async()=>{const t=await _.planApi.deletePlan(d.value.id);t.status===204?(o({type:"success",title:"测试计划删除成功！",duration:1500}),await r.getPlanList(),r.planList.length>0&&w(r.planList[0])):o({title:"测试计划删除失败！",type:"error",message:t.data.detail,duration:1500})}).catch(()=>{ae({type:"info",message:"已取消删除测试计划。",duration:1500})})}const U=le({name:[{required:!0,message:"请输入测试计划名称",trigger:"blur"},{max:20,message:"测试计划名称不得超过20个字符",trigger:"blur"}]}),S=y();async function $(){if(!await S.value.validate().catch(()=>!1))return;const e={...d.value,scene:v.value.map(p=>p.id)},l=await _.planApi.updatePlan(d.value.id,e);l.status===200&&l.data.code!==300?(o({type:"success",title:"测试计划保存成功！",duration:1500}),w(l.data)):o({title:"测试计划保存失败！",type:"error",message:l.data.detail,duration:1500})}async function I(){if(v.value.length>0){const t={env:r.env,plan:d.value.id},e=await _.planApi.runPlan(t);e.status===200&&o({type:"success",title:"测试计划执行成功！",message:"测试计划已提交，请稍后查看执行结果！",duration:1500}),e.status===400&&o({title:"测试计划执行错误！",type:"error",message:e.data.detail,duration:1500})}else o({title:"测试计划执行错误！",type:"warning",message:"当前测试计划中无测试套件！",duration:1500})}async function M(t){let e=[];v.value.forEach(k=>{k.id!==t&&e.push(k.id)});let l={...d.value};l.scene=e;const p=await _.planApi.updatePlan(l.id,l);p.status===200&&p.data.code!==300&&(o({type:"success",title:"测试套件移除成功！",duration:1500}),await x()),p.status===200&&p.data.code===300&&o({title:"测试套件移除失败！",type:"error",message:p.data.detail,duration:1500})}let f=y(!1),h=y([]);function j(){return r.sceneList.filter((t,e)=>!v.value.find(l=>l.id===t.id))}function q(t){t.forEach(e=>{h.value.push(e.id)})}async function F(){if(h.value.length===0){o({type:"warning",title:"请选择至少一个测试套件！",duration:1500});return}let t={...d.value};t.scene.push(...h.value);const e=await _.planApi.updatePlan(t.id,t);e.status===200&&e.data.code!==300?(o({type:"success",title:"测试套件添加成功！",duration:1500}),await x()):o({title:"测试套件添加失败！",type:"error",message:e.data.detail,duration:1500})}return(t,e)=>{const l=u("el-button"),p=u("el-menu-item"),k=u("el-menu"),V=u("el-divider"),O=u("el-input"),G=u("el-form-item"),H=u("el-form"),J=u("el-tooltip"),b=u("el-table-column"),R=u("el-table"),K=u("el-drawer"),Q=re("loading");return g(),P(A,null,[a("div",ue,[a("div",pe,[a("div",ce,[e[6]||(e[6]=a("img",{src:B,width:"25",alt:""},null,-1)),e[7]||(e[7]=a("div",{class:"name"},"测试计划",-1)),s(l,{onClick:N,size:"small",icon:"CirclePlus",type:"primary",plain:""},{default:n(()=>[...e[4]||(e[4]=[m("计划",-1)])]),_:1}),s(l,{plain:"",onClick:c(r).getPlanList,type:"success",icon:"Refresh",size:"small"},{default:n(()=>[...e[5]||(e[5]=[m("刷新",-1)])]),_:1},8,["onClick"])]),c(r).planList.length>0?(g(),D(k,{key:0,"default-active":c(d).id.toString()},{default:n(()=>[(g(!0),P(A,null,de(c(r).planList,i=>(g(),D(p,{onClick:W=>w(i),index:i.id.toString(),key:"item.id"},{default:n(()=>[e[8]||(e[8]=a("img",{src:B,width:"20",style:{"margin-right":"10px"},alt:""},null,-1)),i.name.length<15?(g(),P("span",me,C(i.name),1)):(g(),P("span",fe,C(i.name.slice(0,15))+"...",1))]),_:2},1032,["onClick","index"]))),128))]),_:1},8,["default-active"])):ie("",!0)]),a("div",_e,[a("div",ge,[s(V,{"content-position":"center"},{default:n(()=>[...e[9]||(e[9]=[a("b",null,"基本信息",-1)])]),_:1}),a("div",ve,[s(H,{model:c(d),rules:U,ref_key:"formDataRef",ref:S,style:{flex:"1","margin-right":"10px"}},{default:n(()=>[s(G,{label:"测试计划：",prop:"name"},{default:n(()=>[s(O,{modelValue:c(d).name,"onUpdate:modelValue":e[0]||(e[0]=i=>c(d).name=i),placeholder:"请输入测试计划名称",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),a("div",ye,[s(l,{onClick:e[1]||(e[1]=i=>$(S.value)),icon:"CircleCheck",plain:"",type:"primary"},{default:n(()=>[...e[10]||(e[10]=[m("保存",-1)])]),_:1}),s(l,{onClick:I,plain:"",type:"success",icon:"Promotion"},{default:n(()=>[...e[11]||(e[11]=[m("运行",-1)])]),_:1}),s(J,{class:"box-item",effect:"dark",content:"删除测试计划，将删除计划下的套件、测试报告",placement:"top"},{default:n(()=>[s(l,{onClick:T,plain:"",icon:"Delete",type:"danger"},{default:n(()=>[...e[12]||(e[12]=[m("删除",-1)])]),_:1})]),_:1})])])]),a("div",we,[s(V,{"content-position":"center"},{default:n(()=>[...e[13]||(e[13]=[a("b",null,"测试套件",-1)])]),_:1}),s(l,{onClick:e[2]||(e[2]=i=>E(f)?f.value=!0:f=!0),plain:"",icon:"CirclePlus",size:"small",type:"primary"},{default:n(()=>[...e[14]||(e[14]=[m("套件",-1)])]),_:1}),s(l,{plain:"",onClick:x,type:"success",icon:"Refresh",size:"small"},{default:n(()=>[...e[15]||(e[15]=[m("刷新",-1)])]),_:1}),oe((g(),D(R,{data:c(v),"row-key":"id",style:{width:"100%","margin-top":"10px"},"show-header":!1,stripe:"","element-loading-text":"加载中..."},{empty:n(()=>[...e[16]||(e[16]=[a("div",{class:"table-empty"},[a("img",{src:X,alt:"notData",width:"75"}),a("div",null,"暂无数据")],-1)])]),default:n(()=>[s(b,null,{default:n(i=>[a("div",xe,[e[17]||(e[17]=a("img",{src:Y,width:"20",style:{"margin-right":"5px"},alt:"scene"},null,-1)),a("span",ke,C("测试套件"+(i.$index+1)+"："),1),a("span",null,C(i.row.name),1)])]),_:1}),s(b,{width:"90px"},{default:n(i=>[s(l,{plain:"",size:"small",type:"danger",onClick:W=>M(i.row.id),icon:"Remove"},{default:n(()=>[...e[18]||(e[18]=[m("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Q,L.value]])])])]),s(K,{modelValue:c(f),"onUpdate:modelValue":e[3]||(e[3]=i=>E(f)?f.value=i:f=i),"with-header":!1,direction:"rtl",size:"20%"},{footer:n(()=>[a("div",Pe,[s(l,{onClick:F,plain:"",type:"primary"},{default:n(()=>[...e[19]||(e[19]=[m("确认",-1)])]),_:1})])]),default:n(()=>[e[20]||(e[20]=a("div",{class:"title"},"添加测试套件",-1)),a("div",be,[s(R,{onSelectionChange:q,data:j(),"tooltip-effect":"dark",style:{width:"100%"}},{default:n(()=>[s(b,{type:"selection"}),s(b,{prop:"name",label:"全选"})]),_:1},8,["data"])])]),_:1},8,["modelValue"])],64)}}},Ae=ne(Ce,[["__scopeId","data-v-86c53977"]]);export{Ae as default};
